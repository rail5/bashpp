#!/usr/bin/env bpp
#AUTODOC#

# Copyright (C) 2025 Andrew S. Rightenburg
# GNU General Public License v3.0
# This file is part of the Bash++ Standard Library.

@include_once "SharedArray"

#CLASS TypedSharedArray : SharedArray
## The TypedSharedArray class provides a shared array implementation which enforces type restrictions on its elements.
## After setting the array's type, all elements must be pointers to objects of that type or its subclasses.
## 
## Reads and writes are atomic and concurrency-safe.
## 
## The array can be encrypted for security.
@class TypedSharedArray : SharedArray {
	@protected type=""

	##METHOD public set_type
	### Sets the type of elements that this shared array will hold.
	### This method must be called before adding elements to the array.
	### The array's type cannot be changed after elements have been added.
	###PARAM primitive type
	#### The type to enforce for the elements of this shared array.
	@virtual @public @method set_type type {
		if [[ @this.used -ne 0 ]]; then
			>&2 echo "Error: TypedSharedArray: Cannot change type after the array has been used."
			return 1
		fi
		@this.type="$type"
	}

	@protected @method _check_type value {
		local check=@dynamic_cast<@this.type> "$value"
		if [[ "$check" == @nullptr ]]; then
			>&2 echo "Error: TypedSharedArray: Value '$value' is not of type '@this.type'."
			return 1
		fi
		return 0
	}

	##METHOD public push
	### Adds a value to the end of the shared array, enforcing the specified type.
	###PARAM primitive value
	#### The value to add to the shared array.
	@public @method push value {
		if @this._check_type "$value"; then
			@super.push "$value"
		else
			return 1
		fi
	}

	##METHOD public insert
	### Inserts a value at a specific index in the shared array, enforcing the specified type.
	###PARAM primitive index
	#### The index at which to insert the value.
	###PARAM primitive value
	#### The value to insert into the shared array.
	@public @method insert index value {
		if @this._check_type "$value"; then
			@super.insert "$index" "$value"
		else
			return 1
		fi
	}
}
