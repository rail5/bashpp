#!/usr/bin/env bpp

@include_once "detect-tty.bpp"
@include_once "TestStats.bpp"
@include_once "Test.bpp"
@include_once "TestRunner.bpp"

@TestRunner runner

while getopts "lh" opt; do
	case $opt in
		l)
			for file in test-suite/tests/sources/*.bpp; do
				testName=$(basename "$file" .bpp)
				echo "$testName"
			done
			exit 0
			;;
		h)
			echo "Usage: run.bpp [-l] [test1 test2 ...]"
			echo "If no tests are specified, all tests will be run"
			echo "  -l: List all tests"
			echo "  -h: Display this help message"
			exit 0
			;;
	esac
done

echo "Running tests..."
echo "----------------"

if [[ $# -gt 0 ]]; then
	for testName in "$@"; do
		@runner.addTest "$testName"
		@runner.runTest "$testName"
	done
else
	@runner.addAllTests
	@runner.runAllTests
fi

echo "----------------"
echo "@runner.stats.toPrimitive"

returncode=0

if [[ "@runner.stats.getFailCount" -gt 0 ]]; then
	returncode=1
fi

@runner.stats.clean

exit $returncode
