#!/usr/bin/env bpp

@include_once "detect-tty.bpp"
@include_once "TestStats.bpp"
@include_once "Test.bpp"
@include_once "TestRunner.bpp"

@TestRunner runner

# Hello, world
@runner.addTest "Hello, World" "test-suite/tests/helloworld.bpp" "Hello, World!
Hello, test!
"

# Object references
@runner.addTest "Object References #1" "test-suite/tests/object-references-1.bpp" "Outer Instance
Inner Instance
DeeperInner Instance
DeepestInner Instance
"

# Supershells
@runner.addTest "Supershells" "test-suite/tests/supershells.bpp" "Command matches expected output
Iteration 1
Iteration 2
Iteration 3
Iteration 4
Iteration 5
Iteration 6
Iteration 7
Iteration 8
Iteration 9
Iteration 10
hi
"

# Queue example
@runner.addTest "Queue Example" "test-suite/tests/queue.bpp" "a
b
c
"

# toPrimitive
@runner.addTest "toPrimitive" "test-suite/tests/toprimitive.bpp" "Object Instance
Test Object #2
"

# Constructors and Destructors
@runner.addTest "Constructors and Destructors" "test-suite/tests/constructors-and-destructors.bpp" "Constructor called: John Q\\. Public
Constructor called: John Q\\. Public
Destructing John Q\\. Public
Constructor called: John Q\\. Public
Destructing John Q\\. Public
"

# Includes
@runner.addTest "Includes" "test-suite/tests/include.bpp" "Included file
Including file
"

# Pointers
@runner.addTest "Pointers" "test-suite/tests/pointers.bpp" "default value for primitive data member
.*0__data: invalid variable name
new value for object number 3
new value for object number 3
default value for primitive data member
default value for primitive data member
Bash\\+\\+: Error: Attempted to delete null object
Bash\\+\\+: Error: Attempted to delete null object
Bash\\+\\+: Error: Attempted to delete null object
"

@runner.addTest "Pointer Arguments" "test-suite/tests/pointer-arguments.bpp" "Hello from myMethodWithObject
Object data member: default value
"

# Inheritance
@runner.addTest "Inheritance" "test-suite/tests/inheritance.bpp" "You extend your hand to pet it, but the 60cm, 30kg beast bares its teeth
You pet the dog
You are devoured by the lion
\\.\\.\\.Why did you try to pet a 200kg lion\\?
You are devoured by the lion
\\.\\.\\.Why did you try to pet a 30kg lion\\?
"

# Casting
@runner.addTest "Casting" "test-suite/tests/casting.bpp" "Hello from BaseClass!
default value
Hello from DerivedClass!
default value
Hello from UnrelatedClass!
Hello from BaseClass!
default value
Hello from DerivedClass!
default value
Hello from BaseClass!

"

# Arrays as Data Members
@runner.addTest "Arrays as Data Members #1" "test-suite/tests/arrays-as-datamembers-1.bpp" "hello
hello
hello
hello
1
world
world
world
world
2
hello
hello
hello
hello
world
world
world
world
!
!
!
!
a
a
a
a
b
b
b
b
c
c
c
c
d
d
d
d
"

@runner.addTest "Arrays as Data Members #2" "test-suite/tests/arrays-as-datamembers-2.bpp" "hello
hello
hello
hello
1
world
world
world
world
2
hello
hello
hello
hello
world
world
world
world
!
!
!
!
a
a
a
a
b
b
b
b
c
c
c
c
d
d
d
d
"

@runner.addTest "Arrays as Data Members #3" "test-suite/tests/arrays-as-datamembers-3.bpp" "hello
hello
hello
hello
hello
hello
hello
hello
world
world
world
world
!
!
!
!
"

@runner.addTest "Case statements" "test-suite/tests/case.bpp" "default
case1
case2
otherMember is case4
case3
case4
"

@runner.addTest "If...Elif statements" "test-suite/tests/if-elif.bpp" "default
case1
case2
case3
\@this\\.member is case1
\@this\\.othermember is case1
\@this\\.anothermember is case1
default
"

@runner.addTest "Heredocs" "test-suite/tests/heredocs.bpp" "abc
def
value
hij
"

@runner.addTest "Herestrings" "test-suite/tests/herestrings.bpp" "abc def value hij
"

@runner.addTest "Multiline commands" "test-suite/tests/multiline-commands.bpp" "one two three four five six value hello seven eight nine
"

while getopts "lh" opt; do
	case $opt in
		l)
			@runner.listTests
			exit 0
			;;
		h)
			echo "Usage: run.bpp [-l] [test1 test2 ...]"
			echo "If no tests are specified, all tests will be run"
			echo "  -l: List all tests"
			echo "  -h: Display this help message"
			exit 0
			;;
	esac
done

echo "Running tests..."
echo "----------------"

if [[ $# -gt 0 ]]; then
	for testName in "$@"; do
		@runner.runTest "$testName"
	done
else
	@runner.runAllTests
fi

echo "----------------"
echo "@runner.stats"

if [[ "@runner.stats.getFailCount" -gt 0 ]]; then
	exit 1
fi
